"use strict";app.directive("jstab",["$rootScope","$state","$timeout","JSDataService","$controller","$compile","CacheFactory","$base64","JsPopUpView",function(n,t,i,r,u,f,e,o,s){return{restrict:"E",transclude:!0,scope:{tabs:"=?",currenttabindex:"=?",currenttab:"=?",ontabsclear:"&",register:"&"},link:function(t,o){function v(){for(var n="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<5;i++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}var p=e.get("JSTabCache"),w,c,l,b,h,y,a;t.IsLoadError=!1;t.CloseTab=function(n){n.NewScope!==undefined?n.CloseModule():h(n)};w=function(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};c=function(e,o,s,c,l){var a=null,p=v(),y;switch(s){case 1:a="/JsApp/ListView?ID="+o.ID+"&ViewName="+o.Name;break;case 2:a="/JsApp/DetailView?ID="+o.ID+"&ViewName="+o.Name;break;case 3:a="/ReportView/GetReportController?ID_Report="+e.ID_Report;break;case 5:if(o.ControllerPath==null)throw Error("Controller Path not defined");a="/JsApp/GetScript?Url="+encodeURI(o.ControllerPath);break;case 6:a="/JsApp/TreeView?ID="+o.ID;break;case 7:a="/Analytics/JsDashboard"}o.CurrentUser.IsDeveloperMode!==!0&&(s===1||s===2)&&o.JsController!==null&&(a="/App_Content/ModuleJs/"+o.JsController);s===3&&(o.ViewControllerName=o.Name+"Controller");o.ViewControllerName==null&&(o.ViewControllerName=o.Name+"Controller");y=function(){var t=n.$new(!0),a,y,r,v,w,b;if(e.$ID_View=o.ID,t.PageSlideViewOpen={Open:!1},a={},s==2&&(a.$onCurrentObjectSaved=e.$onCurrentObjectSaved,a.$ClosedAfterSaved=e.$ClosedAfterSaved,a.DataSource=o.DataSource),t.InitView=function(n){t.OnElementInit!=undefined&&t.OnElementInit(n)},e.IsRepaint==!0&&(t.RepaintView=!0,e.Repaint=function(){t.RefreshView!==undefined&&t.RefreshView()}),t.$Tab=e,t.IsHide=!1,t.$params=l,y=function(){e.IsLoadError=!1;e.DisplayMessage="User does not have access on "+o.ModelName+". Please contact your System Administrator.";e.icon="mdi mdi-emoticon-sad";e.ShowProgress=!1;e.BgColor="#bd0000";e.foreColor="#fff";e.IsAllow=!1},t.$CurrentUser=o.CurrentUser,e.IsAllow=!0,r=null,s===2||s===1){if(o.ViewAccess===undefined||o.ViewAccess===null){y();return}if(r=o.ViewAccess[0],r!==undefined&&r.IsDeveloper!==1)if(s===2||s===1){if(!(r.IsAllow===!0&&r.IsDeny!==!0)){y();return}}else if(c.ID===-1&&r.IsCanWrite===!1){alert("User does not allow to create on module "+o.ModelName);return}}(s===1||s===2)&&((r===null||r===undefined)&&(r={}),r.OwnerRights=o.OwnerRights);v=u(o.ViewControllerName,{$scope:t,ViewStateName:null,IsModal:!1,ModalMode:{},CurrentObject:c,ReportParams:l,$ViewOption:a,$ViewAccess:r,$OwnerRights:o.OwnerRights,DashboardSettings:s==7?{Path:o.ViewPath,ViewId:p}:null});s===1&&(v.LvModel.ID_Tab=e.id);s===2&&(v.ListViewTab=e.ListViewTab,t.IsNewObject=!0);t.CloseModule=function(n){if(n!==undefined&&(t.CurrentObject.$dirty=!1),s===2){v.IsFormReadOnly!=!0?t.CurrentObject.$dirty==!0?DevExpress.ui.dialog.confirm("Do you want to discard changes?",o.DisplayName).done(function(n){n&&i(function(){h(e)})}):h(e):h(e);return}h(e)};e.CloseModule=t.CloseModule;s==2&&(e.NewScope=t);w=null;w=s==5?'<div id="'+o.Name+'" class="JsCustomView" ng-include="ViewSrc" style="height:100%"><\/div>':'<div ng-include="ViewSrc" style="height:100%"><\/div>';b=f(w)(t);$("#"+o.ContainerID).attr("tabindex",o.ID);$("#"+o.ContainerID).html(b);e.focusView=function(){i(function(){$("#"+o.ContainerID).focus()},100)};i(function(){switch(s){case 1:t.ViewSrc="/ListView?ID="+o.ID+"&ViewName="+o.Name;break;case 2:t.ViewSrc="/DetailView?ID="+o.ID+"&ViewName="+o.Name;break;case 3:var n=l!=undefined?l!=null?l.ID:0:0;t.ViewSrc="/ReportView/Template?ID="+e.ID_Report+"&ID_CurrentObject="+n;break;case 5:t.ViewSrc="/JsApp/GetView?Url="+encodeURI(o.ViewPath);break;case 6:t.ViewSrc="/JsApp/TreeViewTemplate";break;case 7:t.ViewSrc="/Analytics/Wrapper?ViewName="+p}$("#"+o.ContainerID).bind("keydown",function(n){if(e.onTab_KeyDown!==undefined)e.onTab_KeyDown(n)});$("#"+o.ContainerID).focus()})};r.LoadController(o.ViewControllerName,s,a).then(function(){y()},function(){switch(s){case 1:a="/JsApp/ListView?ID="+o.ID+"&ViewName="+o.Name;break;case 2:a="/JsApp/DetailView?ID="+o.ID+"&ViewName="+o.Name;break;case 3:a="/ReportView/GetReportController?ID_Report="+e.ID_Report}r.LoadController(o.ViewControllerName,s,a).then(function(){y()});t.CloseModule=function(){h(e)};e.IsLoadError=!0})};l={SwitchTab:function(n){n.IsLoadError=!1;n.params==undefined&&(n.params=null);n.DisplayMessage="Intellismart Inc. 2016";a();n.BgColor="#ddd";var t={ID:n.ID_ViewType===3?n.ID_Report:n.ID_View,ID_ViewType:n.ID_ViewType,ViewName:null,ID_Navigation:n.id,ID_CurrentObject:n.ID_CurrentObject};r.GetCurrentObject("/JsApp/GetModelView",t,!1).then(function(t){if(t===null){s.ShowSessionTimeout();return}(n.ID_ViewType===1||n.ID_ViewType===2)&&(n.DisplayMessage="("+t.DisplayName+")",n.icon=t.Icon);n.ID_ViewType===2?t.PrimaryColor!==undefined&&(n.foreColor="#fff",n.BgColor=t.PrimaryColor):n.ID_ViewType===3?(n.BgColor="#ed7a15",n.foreColor="#fff"):n.ID_ViewType===5?(n.BgColor=t.PrimaryColor,n.foreColor="#fff"):n.foreColor=t.PrimaryColor;n.ViewName=v();t.ContainerID=n.ViewName;n.$isInit=!0;n.ID_ViewType===2?n.CurrentObject!==undefined?c(n,t,n.ID_ViewType,n.CurrentObject,n.params):r.GetCurrentObject("/JsApp/GetCurrentObject",{ID:t.ID,ViewName:t.Name,DataSource:t.DataSource,ID_CurrentObject:n.ID_CurrentObject===undefined?-1:n.ID_CurrentObject,params:n.params!=null?JSON.stringify(n.params):null},!1).then(function(i){n.title=t.DisplayName;n.title=n.title.replace("(New)","");n.title=i.ID!==-1?n.title+(i.ID<0?" (New)":" ("+i.ID+")"):n.title+" (New)";c(n,t,n.ID_ViewType,i,n.params)}):n.ID_ViewType===5?t.IsHasDataSource===!0?r.GetCurrentObject("/JsApp/GetCurrentObject",{DataSourceKey:"Ds"+t.Name,params:n.params!=null?JSON.stringify(n.params):null}).then(function(i){c(n,t,n.ID_ViewType,i,n.params)}):c(n,t,n.ID_ViewType):(n.ID_ViewType==3,c(n,t,n.ID_ViewType,null,n.params))})}};b=1;t.tabs==undefined&&(t.tabs=[]);t.$watch("currenttab",function(n){n!=null&&n.ID_ViewType===1&&n.$dirty===!0&&(n.$Refresh(),n.$dirty=!1)});h=function(n){if(n.$scope!==undefined&&n.$scope.$destroy(),$.each(t.tabs,function(i){if(t.tabs[i].id===n.id)return t.tabs.splice(i,1),!1}),t.tabs.length>0){var i=t.tabs[t.tabs.length-1];i.isReload=!1;t.currenttabindex=i.id;t.currenttab=i;t.tabs.length==1&&t.ontabsclear!=undefined&&t.ontabsclear()}a()};y=[{id:1,text:"Close",icon:"fa fa-close"},{id:2,text:"Close others",icon:"mdi mdi-close-box"},{id:3,text:"Close All",icon:"mdi mdi-close-box-outline"},{id:4,text:"Send Feedback",icon:"mdi mdi-send",items:[{id:5,text:"Report a Problem",icon:"mdi mdi-bug"},{id:6,text:"Provide a Suggestion",icon:"mdi mdi-bug"}]}];t.dxContextMenu={items:y,onPositioning:function(n){console.log("positioning",n)},onShowing:function(n){var i=$(n.jQEvent.target),r,u,f;if(i.hasClass("context-menu")||i.hasClass("uib-tab")||i.hasClass("nav-link")){if(r=i.closest("li"),!r.hasClass("active")){n.cancel=!0;return}u=r.index();f=t.tabs[u];n.component.option("CurrentTabID",f.id)}else n.jQEvent.stopPropagation(),n.jQEvent.preventDefault(),n.cancel=!0},onItemClick:function(n){var r=n.component.option("CurrentTabID"),u=Enumerable.From(t.tabs).Where(function(n){return n.id===r}).SingleOrDefault(),f;switch(n.itemData.id){case 1:u.CloseModule();break;case 2:f=Enumerable.From(t.tabs).Where(function(n){return n.id!==r}).ToArray();$.each(f,function(n,t){t.CloseModule()});break;case 3:$.each(t.tabs,function(n,t){i(function(){t.CloseModule()},100)});break;case 5:case 6:u.IssueTracker(n.itemData.id)}}};t.onTabClick=function(n){n.isReload=!1;t.currenttab=n;n.focusView!==undefined&&n.focusView();n.IsRepaint===!0&&(n.IsRepaint=!1,n.Repaint!=undefined&&n.Repaint(),n.Repaint=undefined);a()};a=function(){var n=[];$.each(t.tabs,function(t,i){var i={id:i.id,title:i.title,icon:i.icon,ID_ViewType:i.ID_ViewType,fixed:i.fixed,ID_View:i.ID_View,ID_CurrentObject:i.ID_CurrentObject,ID_Report:i.ID_Report,CurrentObject:i.CurrentObject,params:i.params,ListViewTab:i.ListViewTab,_ID:i._ID};n.push(i)});console.log("=====>CurrentState",n);p.put("/CurrentState",{CurrentTabState:n,CurrentTabIndex:t.currenttabindex})};i(function(){var n=o.find(".tab-content"),r=n.position().top,u=$(window).height();t.ContentHeight=u-r-90;$(n).css({height:t.ContentHeight});l.CloseAllTabs=function(){$.each(t.tabs,function(n,t){i(function(){t.CloseModule()},100)})};l.CloseCurrentTab=function(){var n=Enumerable.From(t.tabs).Where("$.id ==="+t.currenttabindex).SingleOrDefault();n!==undefined&&n.CloseModule()};l.RefreshCache=a;t.register!=undefined&&t.register({TabControl:l})})},templateUrl:"/Templates/JSTabs.tpl.html"}}]);